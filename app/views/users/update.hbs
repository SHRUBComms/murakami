<div class="row">
  <h2>{{first_name}} {{last_name}}</h2>
  <span>{{username}} | {{email}}</span>
  <p>Last login: 
    {{#if last_login}}
      {{last_login}}
    {{else}}
      never</p>
    {{/if}}
</div>

<div class="row">
  <div class="form-group form-inline">
    {{#ifCond user_id '!=' user.id}}
      <a href="/users/deactivate/{{user_id}}" class="btn btn-danger">Deactivate User</a>
    {{ else }}
      <a href="/users/deactivate/{{user_id}}" class="btn btn-danger">Deactivate User (you)</a>
    {{/ifCond}}
    {{#ifCond user_id '==' user.id}}
      <a href="/users/change-password" class="btn btn-primary">Change Password (you will be logged out)</a>
    {{/ifCond}}
  </div>
</div>

<br />

{{#if errors}}
<div class="row">
  <div class="alert alert-danger">{{{errors.0.msg}}}</div>
</div>
{{/if}}

<div class="container">
  <form method="post" action="/users/update/{{user_id}}" class="form-group">

    <div class="row">
      <div class="form-group form-inline">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="First Name" name="first_name"{{#if first_name}} value="{{first_name}}"{{/if}}>
        </div>
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Last Name" name="last_name"{{#if last_name}} value="{{last_name}}"{{/if}}>
        </div>
      </div>
    </div>

    <div class="row">
      <p>Want to change your username or email address? Please <a href="/support">contact support</a>.</p>
    </div>

    <div class="row">
      <h4>Permissions</h4>
    </div>

    <div class="row">
      <div class="form-group form-inline">
        <select class="form-control" name="class">
          <option value="till" {{#ifCond class '==' 'till'}}selected{{/ifCond}}>Till User</option>
          <option value="staff" {{#ifCond class '==' 'staff'}}selected{{/ifCond}}>Staff Admin</option>
        </select>
      </div>
    </div>

  <div id="working_groups">
    <div class="row">
      <h4>Working Groups</h4>
    </div>

    <div class="row">
      <div class="form-group form-inline">
          <div class="form-group">
            <select id="workingGroupSelect" class="form-control">
              {{#each allWorkingGroups}}
                <option value='{"{{group_id}}":"{{name}}"}'>{{name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="form-group">
              <a class="form-control btn btn-primary" onclick="addToJoinList()">Add</a>
          </div>
      </div>
    </div>

    <div class="row">
      <div id="wgInfo">
        <p>User is assigned to:</p>
      </div>
      <ul id="workingGroupJoinSummary"></ul>
    </div>
    <input type="hidden" name="working_groups" id="working_groups_json" value="" />

  </div>

    <hr />

    <div class="row">
      <div class="form-group form-inline">
        <div class="form-group">
            <button type="submit" class="btn btn-primary form-control">Update User</button>
          </div>
      </div>
    </div>


  </form>
</div>

<script>
var joinList = {{{json working_groups}}}

function addToJoinList(){
  var wg = JSON.parse($("#workingGroupSelect").val())
  joinList[Object.keys(wg)[0]] = wg[Object.keys(wg)[0]];
  updateSummary();
}

function removeFromJoinList(key){
  delete joinList[key];
  updateSummary();
}

function updateSummary(){

  $("#working_groups_json").val(JSON.stringify(joinList));

  if(Object.keys(joinList).length === 0 && joinList.constructor === Object){
    $("#wgInfo").addClass("hidden")
  } else {
    $("#wgInfo").removeClass("hidden")
  }

  $("#workingGroupJoinSummary").html("");
  Object.keys(joinList).forEach(function(key) {
    $("#workingGroupJoinSummary").html($("#workingGroupJoinSummary").html() + "<li id='" + key + "'>" + joinList[key] + " - <a onclick='removeFromJoinList(\"" + key + "\")' class='clickable'>remove</a></li>");
  });
  
}

updateSummary();
</script>