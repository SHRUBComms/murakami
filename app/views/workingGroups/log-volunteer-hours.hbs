<div class="row">
  <h1>Log Volunteer Hours ({{working_group.name}})
    </h1>
</div>

{{#ifGreaterThan user.admin_wg.length 1}}
<div class="row">
  <div class="form-group form-inline">
    <select class="form-control" id="working_groups">
      <option disabled selected>Select a working group...</option>
      {{#each user.admin_wg}}
        <option value="{{id}}">{{name}}
        {{#if sub_groups}}
          (General)
          {{#each sub_groups}}
            <option value="{{../id}}-{{id}}">{{../name}}: {{name}}</option>
          {{/each}}
        {{/if}}
        </option>
      {{/each}}
    </select>
  </div>
</div>
{{/ifGreaterThan}}

<div class="row">

  <div class="col-lg-5 nopadding">
    <div id="hours_logged_info" class="row"></div>
    <h3>Log Shifts</h3>
    <p>Enter the name of the member you want to log hours for</p>
    <div class="form-group">
      <input type="text" id="memberInput" class="form-control" placeholder="Name of member..." oninput="search()" />
    </div>

    <div class="row">
      <div class='col-lg-offset-1'>
        <div id="searchOutput"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-5 col-lg-offset-1">

    <div class="row">
      <div id="add_by_mail_info" class="row"></div>
      <h3>Need to log hours of someone who isn't in the system yet?</h3>
      <p>Type in the name and email of the person you want to add - they'll be sent a one-time link to a sign up form
        <br />
        <small>e.g. John Doe &lt;example@mail.com&gt;</small>
      </p>
    </div>

    <div class="row">
      <div class="form-group form-inline">
          <div class="form-group">
              <input type="text" class="form-control" id="batchMailInput" placeholder="John Doe <example@mail.com>" />
          </div>
          <div class="form-group">
              <a class="btn btn-primary" id="addByMailSubmit" onclick="postAddresses()">Send Sign Up Link</a>
          </div>
      </div>
    </div>

  </div>

</div>


<script>
function search(){
  $.ajax({
      type: "POST",
      url: "/working-groups/members/search",
      data: { 
          'term': $('#memberInput').val(),
          'group_id': "{{working_group.id}}"
      },    
      success: function(response){

        if(response.status == "ok"){
          updateSearchOutput(response.results);
        } else {
          $('#searchOutput').html("Something went wrong!");
        }  
      }
  });
}

function updateSearchOutput(results){
  $('#searchOutput').html("<br />");

  if(results.length == 0) {
    $('#searchOutput').html($('#searchOutput').html() + "<div class='member-result'>" +
      "<p class='text-center'>Nothing found :'( - <a href='/members/add' target='_blank'>add a new member</a></p>" +
      "</div>");
  } else {
    for(i=0;i<results.length;i++){

      var shiftLogger = '<div class="row">' +
                          '<div class="col-lg-6">' +
                            '<label>Duration</label>' +
                            '<input type="range" id="duration_' + results[i].id + '" oninput="updateDuration(' + results[i].id + ')" name="duration" min="0.25" max="24" step="0.25" value="0" />' +
                          '</div>' +
                          '<div class="col-lg-6">' +
                            '<p><b><span id="duration_' + results[i].id + '_value">0</span> hour(s)</b></p>' +
                            '<p><span id="projected_tokens_' + results[i].id + '"></span></p>';
                          '</div>' +                          
                        '</div>'

      var logHoursBtn = "<a class='btn btn-primary' onclick='logHours(" + results[i].id +  ")'>Log Hours</a>"
      
      $('#searchOutput').html($('#searchOutput').html() + 
        "<div class='member-result text-center'>" +
          "<p><b>" + 
            "<a href='/members/view/" + results[i].id + "' target='_blank'>" +
              results[i].name + 
            "</a>" +
          "</p></b>" +

          "<p>" + 
            results[i].email + 
          "</p>" +
          "<hr />" +
          shiftLogger +
          "<center>" +
            logHoursBtn +
          "</center>" +
        "</div>"
      );

      if((i + 1) != results.length){
        $('#searchOutput').html($('#searchOutput').html() + "<hr />")
      }

      var found = false;
    }
  }
}

function updateDuration(member){
  var duration = $("#duration_" + member).val()
  $("#duration_" + member + "_value").html(duration);
  $("#projected_tokens_" + member).html(Math.floor(duration) * {{working_group.rate}} + " tokens ({{working_group.rate}} per hour)") 
}

$('#working_groups').on('change', function () {
  var url = "/working-groups/log-volunteer-hours/" + $(this).val();
  window.location = url;
});

function postAddresses(){
  $('#addByMailSubmit').attr('disabled', true);
  var input = $("#batchMailInput").val()
  var name = input.substr(0, input.indexOf('<'));
  var address = input.substring(
    input.lastIndexOf("<") + 1, 
    input.lastIndexOf(">")
  );

  if(!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(input)){
    if(name != null){
      if(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(address)){
       $.ajax({
          type: "POST",
          url: "/working-groups/add-members/{{working_group.id}}",
          data: {
            name: name,
            address: address,
            working_group: "{{#if working_group.prefix}}{{working_group.prefix}} {{/if}}{{working_group.name}}"
          },
          success: function(response){
            console.log(response);
            $('#addByMailSubmit').removeAttr('disabled');
            if(response.status == "ok"){
              $("#add_by_mail_info").html('<div class="alert alert-success" onclick="dismiss(\'#add_by_mail_info\')">' + response.msg + '</div>');
            } else {
              $("#add_by_mail_info").html('<div class="alert alert-danger" onclick="dismiss(\'#add_by_mail_info\')">' + response.msg + '</div>');
            }
          }
       });

      } else {
        $('#addByMailSubmit').removeAttr('disabled');
        $("#add_by_mail_info").html('<div class="alert alert-danger" onclick="dismiss(\'#add_by_mail_info\')">Please enter a valid email address</div>');
      }
    } else {
      $('#addByMailSubmit').removeAttr('disabled');
      $("#add_by_mail_info").html('<div class="alert alert-danger" onclick="dismiss(\'#add_by_mail_info\')">Please enter a name</div>');    
    }
  } else {
    $('#addByMailSubmit').removeAttr('disabled');
    $("#add_by_mail_info").html('<div class="alert alert-danger" onclick="dismiss(\'#add_by_mail_info\')">Please put the details in the correct format - John Doe &lt;example@mail.com&gt;</div>');     
  }

}

function logHours(member_id){
  var duration = $("#duration_" + member_id).val();
   $.ajax({
      type: "POST",
      url: "/working-groups/log-volunteer-hours",
      data: {
        shift: {
          member_id: member_id,
          duration: duration,
          working_group: "{{working_group.id}}"
        }
      },
      success: function(response){
        console.log(response);
        search();
        if(response.status == "ok"){
          $("#hours_logged_info").html('<div class="alert alert-success" onclick="dismiss(\'#hours_logged_info\')">' + response.msg + '</div>');
        } else {
          $("#hours_logged_info").html('<div class="alert alert-danger" onclick="dismiss(\'#hours_logged_info\')">' + response.msg + '</div>');
        }
      }
   });
}

</script>